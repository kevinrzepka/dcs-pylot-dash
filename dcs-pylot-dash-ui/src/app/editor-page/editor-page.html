<!--
Copyright (c) 2025 Kevin Rzepka <kdev@posteo.com>
SPDX-License-Identifier: MIT
License-Filename: LICENSE
-->
<div class="editorFrame">
  <div
    class="dataPointRow"
    cdkDropListGroup
    cdkDropList
    [cdkDropListData]="editorModel.dataPointRows"
    (cdkDropListDropped)="dataPointRowDropped($event)"
  >
    @for (dataPointRow of editorModel.dataPointRows; track dataPointRow) {
      <p-card>
        <div
          class="data-point-row"
          cdkDrag
          cdkDropList
          cdkDropListOrientation="horizontal"
          [cdkDropListData]="dataPointRow"
          (cdkDropListDropped)="dataPointDropped($event)"
        >
          <div class="row-drag-placeholder" *cdkDragPlaceholder></div>
          <div class="row-controls">
            <i class="pi pi-arrows-v" cdkDragHandle></i>
            <p-button
              icon="pi pi-trash"
              severity="danger"
              [pTooltip]="'Remove this row'"
              (click)="removeDataPointRow(dataPointRow)"
            />
          </div>
          @for (dataPoint of dataPointRow.dataPoints; track dataPoint) {
            <app-data-point-editor
              cdkDrag
              [dataPoint]="dataPoint"
              (onDeleteDataPoint)="removeDataPoint(dataPointRow, $event)"
              (onChangeDataPoint)="handleDataPointChanged($event)"
            >
              <div class="data-point-drag-placeholder" *cdkDragPlaceholder></div>
            </app-data-point-editor>
          }
          <app-source-data-point-chooser
            [label]="'Add Data Point'"
            [tooltip]="'Choose a source field to add a new data point to this row'"
            [clearAfterEmit]="true"
            [disabled]="dataPointRow.dataPoints.length >= maxDataPointsPerRow"
            (onSourceDataPointChange)="addDataPointInRow($event, dataPointRow)"
          />
        </div>
      </p-card>
    }
  </div>
  <p-card>
    <app-source-data-point-chooser
      class="add-data-point-row"
      [label]="'Add Data Point'"
      [tooltip]="'Choose a source field to add a new data point in a new row'"
      [clearAfterEmit]="true"
      [disabled]="editorModel.dataPointRows.length >= maxRows"
      (onSourceDataPointChange)="addDataPointInRow($event)"
    />
  </p-card>
  <p-card class="generator-container">
    <div class="generator-buttons-container">
      <p-button
        class="build-button"
        label="Build"
        [raised]="true"
        severity="success"
        icon="pi pi-hammer"
        (click)="generate()"
        [disabled]="!generateButtonEnabled"
      />

      <a
        #downloadLink
        pButton
        class="download-button"
        [download]="downloadFilename"
        [href]="downloadUrl"
        [raised]="true"
        severity="success"
        [style]="!downloadButtonEnabled ? { display: 'none' } : {}"
      >
        <i class="pi pi-download"></i>
        {{ downloadFilename }}
      </a>

      <p-popover #downloadPopover>
        <p-card class="download-popover-content" header="Next Steps" title="Next Steps">
          <ol>
            <li>Click to download the .zip archive</li>
            <li>Extract the archive anywhere</li>
            <li>See the attached readme.txt for instructions</li>
          </ol>
        </p-card>
      </p-popover>

      <p-button
        #downloadAfterBuildButton
        class="build-button"
        [pClass]="downloadAfterBuildButtonStyleClass"
        label="Download available after build"
        [raised]="true"
        severity="secondary"
        icon="pi pi-pi-download"
        [disabled]="true"
      />
    </div>
  </p-card>
</div>
