<!--
Copyright (c) 2025 Kevin Rzepka <kdev@posteo.com>
SPDX-License-Identifier: MIT
License-Filename: LICENSE
-->
<p-dialog [(visible)]="loadSampleModelDialogVisible" [modal]="true">
  <ng-template #header>
    <h3 class="font-bold whitespace-nowrap">Are you sure?</h3>
  </ng-template>
  <p>Are you sure you want to discard all changes and load the sample model instead?</p>
  <ng-template #footer>
    <p-button
      label="Cancel"
      icon="pi pi-times"
      severity="secondary"
      (click)="loadSampleModelDialogVisible = false"
    />
    <p-button
      label="Confirm"
      icon="pi pi-check"
      severity="danger"
      (click)="confirmLoadSampleModel()"
    />
  </ng-template>
</p-dialog>
<p-dialog [(visible)]="clearModelDialogVisible" [modal]="true">
  <ng-template #header>
    <h3 class="font-bold whitespace-nowrap">Are you sure?</h3>
  </ng-template>
  <p>Are you sure you want to discard all changes and clear the entire model?</p>
  <ng-template #footer>
    <p-button
      label="Cancel"
      icon="pi pi-times"
      severity="secondary"
      (click)="clearModelDialogVisible = false"
    />
    <p-button label="Clear" icon="pi pi-trash" severity="danger" (click)="confirmClearModel()" />
  </ng-template>
</p-dialog>

<div class="editorFrame">
  <app-backend-status-messages></app-backend-status-messages>
  <p-card class="editorControlsFrame">
    <p-button
      #loadSampleModelButton
      label="Load Sample Model"
      severity="help"
      icon="pi pi-lightbulb"
      (click)="loadSampleModel()"
      [disabled]="!loadSampleModelButtonEnabled"
    />
    <p-popover #sampleModelPopover>
      <p-card header="1. Getting started">
        <p>Loading the sample model is the easiest way to get started. Try it!</p>
      </p-card>
    </p-popover>
    <p-button
      icon="pi pi-cog"
      severity="secondary"
      label="Advanced Settings"
      (click)="showAdvancedSettings()"
    />
    <p-button
      icon="pi pi-trash"
      severity="danger"
      label="Clear Model"
      (click)="clearModelDialogVisible = true"
      [disabled]="!clearModelButtonEnabled"
    />
  </p-card>
  <div
    class="dataPointRow"
    cdkDropListGroup
    cdkDropList
    [cdkDropListData]="editorModel.dataPointRows"
    (cdkDropListDropped)="dataPointRowDropped($event)"
  >
    @for (dataPointRow of editorModel.dataPointRows; track dataPointRow) {
      <p-card>
        <div
          class="data-point-row"
          cdkDrag
          cdkDropList
          cdkDropListOrientation="horizontal"
          [cdkDropListData]="dataPointRow"
          (cdkDropListDropped)="dataPointDropped($event)"
        >
          <div class="row-drag-placeholder" *cdkDragPlaceholder></div>
          <div class="row-controls">
            <i class="pi pi-arrows-v" cdkDragHandle></i>
            <p-button
              icon="pi pi-trash"
              severity="danger"
              [pTooltip]="'Remove this row'"
              (click)="removeDataPointRow(dataPointRow)"
            />
          </div>
          @for (dataPoint of dataPointRow.dataPoints; track dataPoint) {
            <app-data-point-editor
              cdkDrag
              [dataPoint]="dataPoint"
              (onDeleteDataPoint)="removeDataPoint(dataPointRow, $event, addDataPointInRowChooser)"
              (onChangeDataPoint)="handleDataPointChanged()"
            >
              <div class="data-point-drag-placeholder" *cdkDragPlaceholder></div>
            </app-data-point-editor>
          }
          <app-source-data-point-chooser
            #addDataPointInRowChooser
            [label]="'Add Data Point'"
            [tooltip]="'Choose a source field to add a new data point to this row'"
            [clearAfterEmit]="true"
            (onSourceDataPointChange)="addDataPointInRow($event, dataPointRow)"
          />
        </div>
      </p-card>
    }
  </div>
  <p-card>
    <app-source-data-point-chooser
      #addDataPointRowChooser
      class="add-data-point-row"
      [label]="'Add Data Point'"
      [tooltip]="'Choose a source field to add a new data point in a new row'"
      [clearAfterEmit]="true"
      (onSourceDataPointChange)="addDataPointInRow($event)"
    />
    <p-popover #modellingPopover>
      <p-card class="modellingPopover" header="2. Modelling">
        <p>
          The model consists of rows, and each row contains data points, which will display the
          desired plane data coming from a "source field".
        </p>
        <p>
          You can drag and drop data points to move them around, and you can even move entire rows.
        </p>
        <p>
          Some data points offer to be displayed in different units of measurement. You can also
          show the same data point multiple times with different units.
        </p>
      </p-card>
    </p-popover>
  </p-card>
  <p-card class="generator-container">
    <div class="generator-buttons-container">
      <p-button
        #buildButton
        class="build-button"
        label="Build"
        [raised]="true"
        severity="success"
        icon="pi pi-hammer"
        (click)="generate()"
        [disabled]="!generateButtonEnabled"
      />
      <p-popover #buildPopover>
        <p-card header="3. Final steps">
          <p>
            When you are done modelling, build your model to download the generated code along with
            instructions.
          </p>
        </p-card>
      </p-popover>

      <a
        #downloadLink
        pButton
        class="download-button"
        [download]="downloadFilename"
        [href]="downloadUrl"
        [raised]="true"
        severity="success"
        [style]="!downloadButtonEnabled ? { display: 'none' } : {}"
      >
        <i class="pi pi-download"></i>
        {{ downloadFilename }}
      </a>

      <p-popover #downloadPopover>
        <p-card class="downloadPopoverContent" header="Next Steps" title="Next Steps">
          <ol>
            <li>Click to download the .zip archive</li>
            <li>Extract the archive anywhere</li>
            <li>See the attached readme.txt for instructions</li>
          </ol>
          <p>
            Note: The generated HTML page loads Bootstrap (https://getbootstrap.com) and a font from
            Google fonts. Feel free to look at the source code.
          </p>
        </p-card>
      </p-popover>

      <p-button
        #downloadAfterBuildButton
        class="build-button"
        [pClass]="downloadAfterBuildButtonStyleClass"
        label="Download available after build"
        [raised]="true"
        severity="secondary"
        icon="pi pi-download"
        [disabled]="true"
      />
    </div>
  </p-card>

  <p-dialog
    header="Advanced Settings"
    [(visible)]="advancedSettingsDialogVisible"
    [modal]="true"
    [style]="{ minWidth: '20vw' }"
  >
    <div class="advancedSettingsGroup">
      <p-checkbox
        inputId="fcOverrideDefaults"
        [binary]="true"
        [formControl]="fcOverrideDefaults"
        pTooltip="Please only change these settings if you know what you are doing and understand the security implications!"
      />
      <label for="fcOverrideDefaults">Override default settings</label>
      <p-iftalabel>
        <label for="fcBindAddress">Lua HTTP Server Bind Address</label>
        <input
          id="fcBindAddress"
          type="text"
          pInputText
          [formControl]="fcBindAddress"
          pTooltip="The address to which the lua server socket will bind. WARNING: Only change this value if you understand the security implications!"
        />
      </p-iftalabel>
      <p-iftalabel>
        <label for="fcBindPort"
          >Lua HTTP Server Bind Port [{{ AdvancedSettingsConstraints.LUA_BIND_PORT_MIN }} -{{
            AdvancedSettingsConstraints.LUA_BIND_PORT_MAX
          }}]</label
        >
        <input
          id="fcBindPort"
          type="number"
          pInputText
          [min]="AdvancedSettingsConstraints.LUA_BIND_PORT_MIN"
          [max]="AdvancedSettingsConstraints.LUA_BIND_PORT_MAX"
          [formControl]="fcBindPort"
          pTooltip="The port to which the lua server socket will bind"
        />
      </p-iftalabel>
      <p-iftalabel>
        <label for="fcPollIntervalMs"
          >Update Interval (ms) [{{ AdvancedSettingsConstraints.POLL_INTERVAL_MS_MIN }} -{{
            AdvancedSettingsConstraints.POLL_INTERVAL_MS_MAX
          }}]</label
        >
        <input
          id="fcPollIntervalMs"
          type="number"
          pInputText
          [min]="AdvancedSettingsConstraints.POLL_INTERVAL_MS_MIN"
          [max]="AdvancedSettingsConstraints.POLL_INTERVAL_MS_MAX"
          [formControl]="fcPollIntervalMs"
          pTooltip="The interval in milliseconds between data updates"
        />
      </p-iftalabel>
    </div>
    <ng-template #footer>
      <div class="advancedSettingsFooterButtons">
        <p-button
          label="Revert"
          severity="secondary"
          icon="pi pi-undo"
          [raised]="true"
          (click)="resetAdvancedSettings()"
        />
        <p-button
          label="Cancel"
          severity="secondary"
          icon="pi pi-times"
          [raised]="true"
          (click)="advancedSettingsDialogVisible = false"
        />
        <p-button
          class="build-button"
          label="Save"
          severity="success"
          icon="pi pi-check"
          (click)="saveAdvancedSettings()"
        />
      </div>
    </ng-template>
  </p-dialog>
</div>
